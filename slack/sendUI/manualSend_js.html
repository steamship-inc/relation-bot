<script>
  var selectedMunicipalityCode = null;
  var configs = {};

  function setConfigs(configData) {
    configs = configData;
    console.log('Configsè¨­å®šå®Œäº†:', Object.keys(configs).length, 'è‡ªæ²»ä½“');
  }

  function filterMunicipalities() {
    var searchTerm = document.getElementById('searchBox').value.toLowerCase();
    var items = document.querySelectorAll('.municipality-item');
    var noResultsMsg = document.querySelector('.no-results');
    var hasResults = false;

    // æ—¢å­˜ã®ã€Œæ¤œç´¢çµæœãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    if (noResultsMsg) {
      noResultsMsg.remove();
    }

    items.forEach(function(item) {
      var name = item.querySelector('.municipality-name').textContent.toLowerCase();
      var channel = item.querySelector('.municipality-channel').textContent.toLowerCase();
      
      if (searchTerm === '' || name.includes(searchTerm) || channel.includes(searchTerm)) {
        item.classList.remove('hidden');
        hasResults = true;
      } else {
        item.classList.add('hidden');
      }
    });

    // æ¤œç´¢çµæœãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    if (!hasResults && searchTerm !== '') {
      var msg = document.createElement('div');
      msg.className = 'no-results';
      msg.textContent = 'ã€Œ' + searchTerm + 'ã€ã«ä¸€è‡´ã™ã‚‹è‡ªæ²»ä½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
      document.getElementById('municipalityList').appendChild(msg);
    }
  }

  function selectMunicipality(municipalityId) {
    // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.municipality-item').forEach(function(item) {
      item.classList.remove('selected');
    });

    // æ–°ã—ã„é¸æŠã‚’è¨­å®š
    var selectedItem = document.querySelector('[data-id="' + municipalityId + '"]');
    if (selectedItem && !selectedItem.classList.contains('hidden')) {
      selectedItem.classList.add('selected');
      selectedMunicipalityCode = municipalityId;
      document.getElementById('confirmBtn').disabled = false;
      
      // é¸æŠã•ã‚ŒãŸè‡ªæ²»ä½“åã¨ãƒ•ã‚£ãƒ«ã‚¿æƒ…å ±ã‚’è¡¨ç¤º
      var municipalityName = configs[municipalityId].name;
      var filterInfo = configs[municipalityId].slackNotificationFilter;
      
      var buttonText = 'ã€Œ' + municipalityName + 'ã€ã«é€ä¿¡';
      if (filterInfo) {
        buttonText += ' (ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨)';
      } else {
        buttonText += ' (å…¨ä»¶é€ä¿¡)';
      }
      
      document.getElementById('confirmBtn').textContent = buttonText;
      
      // ãƒ•ã‚£ãƒ«ã‚¿è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
      showFilterInfo(municipalityId, filterInfo);
    }
  }

  function showFilterInfo(municipalityId, filterInfo) {
    // æ—¢å­˜ã®ãƒ•ã‚£ãƒ«ã‚¿æƒ…å ±è¡¨ç¤ºã‚’å‰Šé™¤
    var existingFilterInfo = document.querySelector('.filter-info');
    if (existingFilterInfo) {
      existingFilterInfo.remove();
    }

    var selectedItem = document.querySelector('[data-id="' + municipalityId + '"]');
    if (!selectedItem) return;

    var filterInfoDiv = document.createElement('div');
    filterInfoDiv.className = 'filter-info';
    
    if (!filterInfo) {
      filterInfoDiv.innerHTML = 
        '<div class="filter-status no-filter">' +
          '<span class="filter-icon">ğŸ“‹</span>' +
          '<span class="filter-text">ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãªã— - å…¨ãƒã‚±ãƒƒãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™</span>' +
        '</div>';
    } else {
      var filterDetails = [];
      
      if (filterInfo.include_label_ids && filterInfo.include_label_ids.length > 0) {
        filterDetails.push('ãƒ©ãƒ™ãƒ«: ' + filterInfo.include_label_ids.length + 'å€‹æŒ‡å®š');
      }
      
      if (filterInfo.include_case_category_ids && filterInfo.include_case_category_ids.length > 0) {
        filterDetails.push('åˆ†é¡: ' + filterInfo.include_case_category_ids.length + 'å€‹æŒ‡å®š');
      }
      
      var detailText = filterDetails.length > 0 ? filterDetails.join(' / ') : 'æ¡ä»¶è¨­å®šæ¸ˆã¿';
      
      filterInfoDiv.innerHTML = 
        '<div class="filter-status has-filter">' +
          '<span class="filter-icon">ğŸ”</span>' +
          '<span class="filter-text">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨: ' + detailText + '</span>' +
        '</div>';
    }
    
    selectedItem.appendChild(filterInfoDiv);
  }

  function confirmSelection() {
    console.log('confirmSelectionå‘¼ã³å‡ºã—, selectedMunicipalityCode:', selectedMunicipalityCode);
    if (selectedMunicipalityCode) {
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢
      var confirmBtn = document.getElementById('confirmBtn');
      confirmBtn.disabled = true;
      
      console.log('processSelectedMunicipalityå‘¼ã³å‡ºã—é–‹å§‹:', selectedMunicipalityCode);
      
      // é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
      showProgressDialog(configs[selectedMunicipalityCode].name);
      
      // é¸æŠçµæœã‚’ç›´æ¥æ¸¡ã—ã¦ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
      setTimeout(function() { updateProgress('config', 'success'); }, 500);
      setTimeout(function() { updateProgress('tickets', 'success'); }, 1000);
      setTimeout(function() { updateProgress('filter', 'success'); }, 1200);
      setTimeout(function() { updateProgress('slack', 'success'); }, 1500);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('processSelectedMunicipalityæˆåŠŸ:', result);
          
          if (!result.success) {
            if (result.reason === 'no_tickets') {
              updateProgress('â­ï¸ ãƒã‚±ãƒƒãƒˆãªã—ã®ãŸã‚é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ', 'skipped');
            } else if (result.reason === 'no_filtered_tickets') {
              updateProgress('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒã‚±ãƒƒãƒˆãŒãªã„ãŸã‚é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ', 'skipped');
              showFilterResult(result);
            }
          } else {
            updateProgress('âœ… é€ä¿¡å®Œäº†', 'success');
            showFilterResult(result);
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ‰‹å‹•ã§é–‰ã˜ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã®ãŸã‚ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          showCloseButton();
        })
        .withFailureHandler(function(error) {
          console.error('processSelectedMunicipalityå¤±æ•—:', error);
          updateProgress('âŒ ã‚¨ãƒ©ãƒ¼: ' + error, 'error');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'ã€Œ' + configs[selectedMunicipalityCode].name + 'ã€ã«é€ä¿¡';
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ‰‹å‹•ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          showCloseButton();
        })
        .processSelectedMunicipality(selectedMunicipalityCode);
    } else {
      console.log('è‡ªæ²»ä½“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
  }

  function showFilterResult(result) {
    var filterResultDiv = document.createElement('div');
    filterResultDiv.className = 'filter-result';
    
    var filterStatus = '';
    if (!result.filterSettings) {
      filterStatus = 'ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãªã— - å…¨ãƒã‚±ãƒƒãƒˆå¯¾è±¡';
    } else {
      var conditions = [];
      if (result.filterSettings.include_label_ids && result.filterSettings.include_label_ids.length > 0) {
        conditions.push('ãƒ©ãƒ™ãƒ«' + result.filterSettings.include_label_ids.length + 'å€‹');
      }
      if (result.filterSettings.include_case_category_ids && result.filterSettings.include_case_category_ids.length > 0) {
        conditions.push('åˆ†é¡' + result.filterSettings.include_case_category_ids.length + 'å€‹');
      }
      filterStatus = 'ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨: ' + (conditions.length > 0 ? conditions.join(' / ') : 'æ¡ä»¶è¨­å®šæ¸ˆã¿');
    }
    
    filterResultDiv.innerHTML = 
      '<div class="filter-summary">' +
        '<h3>ğŸ“Š ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨çµæœ</h3>' +
        '<div class="filter-detail">' +
          '<div class="count-info">' +
            '<span class="original-count">å…ƒãƒã‚±ãƒƒãƒˆæ•°: ' + result.originalCount + 'ä»¶</span>' +
            '<span class="arrow">â†’</span>' +
            '<span class="filtered-count">é€ä¿¡å¯¾è±¡: ' + result.filteredCount + 'ä»¶</span>' +
          '</div>' +
          '<div class="filter-status-text">' + filterStatus + '</div>' +
        '</div>' +
      '</div>';
    
    var progressResult = document.getElementById('progressResult');
    progressResult.appendChild(filterResultDiv);
  }

  function showCloseButton() {
    // æ—¢å­˜ã®ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³ãŒã‚ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (document.getElementById('manualCloseBtn')) {
      return;
    }
    
    var closeButtonDiv = document.createElement('div');
    closeButtonDiv.className = 'manual-close-section';
    closeButtonDiv.innerHTML = 
      '<button id="manualCloseBtn" class="btn btn-primary manual-close-btn" onclick="google.script.host.close()">' +
        'é–‰ã˜ã‚‹' +
      '</button>';
    
    var progressResult = document.getElementById('progressResult');
    progressResult.appendChild(closeButtonDiv);
  }

  function showProgressDialog(municipalityName) {
    // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’éš ã™
    document.querySelector('.container').style.display = 'none';
    
    // é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä½œæˆ
    var progressContainer = document.createElement('div');
    progressContainer.id = 'progressContainer';
    progressContainer.className = 'progress-container';
    progressContainer.innerHTML = 
      '<div class="progress-header">' +
        '<h2>ğŸš€ ã€Œ' + municipalityName + 'ã€ã¸ã®é€ä¿¡ä¸­</h2>' +
      '</div>' +
      '<div class="progress-steps">' +
        '<div class="progress-step" id="step1">' +
          '<div class="step-icon">â³</div>' +
          '<div class="step-text">è‡ªæ²»ä½“è¨­å®šã‚’å–å¾—ä¸­...</div>' +
          '<div class="step-time">0.1ã€œ0.3ç§’</div>' +
        '</div>' +
        '<div class="progress-step" id="step2">' +
          '<div class="step-icon">â³</div>' +
          '<div class="step-text">ãƒã‚±ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºä¸­...</div>' +
          '<div class="step-time">0.1ã€œ0.5ç§’</div>' +
        '</div>' +
        '<div class="progress-step" id="step3">' +
          '<div class="step-icon">â³</div>' +
          '<div class="step-text">ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’é©ç”¨ä¸­...</div>' +
          '<div class="step-time">0.01ã€œ0.1ç§’</div>' +
        '</div>' +
        '<div class="progress-step" id="step4">' +
          '<div class="step-icon">â³</div>' +
          '<div class="step-text">Slack APIã«é€ä¿¡ä¸­...</div>' +
          '<div class="step-time">0.5ã€œ3ç§’</div>' +
        '</div>' +
      '</div>' +
      '<div class="progress-result" id="progressResult"></div>';
    
    document.body.appendChild(progressContainer);
  }

  function updateProgress(step, status, message) {
    var stepMap = {
      'config': 'step1',
      'tickets': 'step2', 
      'filter': 'step3',
      'slack': 'step4'
    };
    
    if (stepMap[step]) {
      var stepElement = document.getElementById(stepMap[step]);
      var icon = stepElement.querySelector('.step-icon');
      var text = stepElement.querySelector('.step-text');
      
      if (status === 'success') {
        icon.textContent = 'âœ…';
        stepElement.classList.add('completed');
      } else if (status === 'skipped') {
        icon.textContent = 'â­ï¸';
        stepElement.classList.add('skipped');
      } else if (status === 'error') {
        icon.textContent = 'âŒ';
        stepElement.classList.add('error');
      }
      
      if (message) {
        text.textContent = message;
      }
    } else {
      // æœ€çµ‚çµæœã®è¡¨ç¤º
      var resultElement = document.getElementById('progressResult');
      resultElement.textContent = step;
      resultElement.className = 'progress-result ' + status;
    }
  }

  function hideProgressDialog() {
    var progressContainer = document.getElementById('progressContainer');
    if (progressContainer) {
      progressContainer.remove();
    }
    document.querySelector('.container').style.display = 'block';
  }

  // DOMãƒ­ãƒ¼ãƒ‰å¾Œã®åˆæœŸåŒ–
  function initializeDialog() {
    // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§æ¤œç´¢çµæœãŒ1ã¤ã®å ´åˆã¯è‡ªå‹•é¸æŠ
    var searchBox = document.getElementById('searchBox');
    if (searchBox) {
      searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          var visibleItems = document.querySelectorAll('.municipality-item:not(.hidden)');
          if (visibleItems.length === 1) {
            var municipalityId = visibleItems[0].getAttribute('data-id');
            selectMunicipality(municipalityId);
            confirmSelection();
          }
        }
      });

      // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      searchBox.focus();
    }
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDialog);
  } else {
    initializeDialog();
  }
</script>
