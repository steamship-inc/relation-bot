<script>
  var selectedMunicipalityCode = null;
  var configs = {};

  function setConfigs(configData) {
    configs = configData;
    console.log('Configs設定完了:', Object.keys(configs).length, '自治体');
  }

  function filterMunicipalities() {
    var searchTerm = document.getElementById('searchBox').value.toLowerCase();
    var items = document.querySelectorAll('.municipality-item');
    var noResultsMsg = document.querySelector('.no-results');
    var hasResults = false;

    // 既存の「検索結果なし」メッセージを削除
    if (noResultsMsg) {
      noResultsMsg.remove();
    }

    items.forEach(function(item) {
      var name = item.querySelector('.municipality-name').textContent.toLowerCase();
      var channel = item.querySelector('.municipality-channel').textContent.toLowerCase();
      
      if (searchTerm === '' || name.includes(searchTerm) || channel.includes(searchTerm)) {
        item.classList.remove('hidden');
        hasResults = true;
      } else {
        item.classList.add('hidden');
      }
    });

    // 検索結果がない場合のメッセージ表示
    if (!hasResults && searchTerm !== '') {
      var msg = document.createElement('div');
      msg.className = 'no-results';
      msg.textContent = '「' + searchTerm + '」に一致する自治体が見つかりません';
      document.getElementById('municipalityList').appendChild(msg);
    }
  }

  function selectMunicipality(municipalityId) {
    // 既存の選択を解除
    document.querySelectorAll('.municipality-item').forEach(function(item) {
      item.classList.remove('selected');
    });

    // 新しい選択を設定
    var selectedItem = document.querySelector('[data-id="' + municipalityId + '"]');
    if (selectedItem && !selectedItem.classList.contains('hidden')) {
      selectedItem.classList.add('selected');
      selectedMunicipalityCode = municipalityId;
      document.getElementById('confirmBtn').disabled = false;
      
      // 選択された自治体名とフィルタ情報を表示
      var municipalityName = configs[municipalityId].name;
      var filterInfo = configs[municipalityId].slackNotificationFilter;
      
      var buttonText = '「' + municipalityName + '」に送信';
      if (filterInfo) {
        buttonText += ' (フィルタ適用)';
      } else {
        buttonText += ' (全件送信)';
      }
      
      document.getElementById('confirmBtn').textContent = buttonText;
      
      // フィルタ詳細情報を表示
      showFilterInfo(municipalityId, filterInfo);
    }
  }

  function showFilterInfo(municipalityId, filterInfo) {
    // 既存のフィルタ情報表示を削除
    var existingFilterInfo = document.querySelector('.filter-info');
    if (existingFilterInfo) {
      existingFilterInfo.remove();
    }

    var selectedItem = document.querySelector('[data-id="' + municipalityId + '"]');
    if (!selectedItem) return;

    var filterInfoDiv = document.createElement('div');
    filterInfoDiv.className = 'filter-info';
    
    if (!filterInfo) {
      filterInfoDiv.innerHTML = 
        '<div class="filter-status no-filter">' +
          '<span class="filter-icon">📋</span>' +
          '<span class="filter-text">フィルタ設定なし - 全チケットが送信されます</span>' +
        '</div>';
    } else {
      var filterDetails = [];
      
      if (filterInfo.include_label_ids && filterInfo.include_label_ids.length > 0) {
        filterDetails.push('ラベル: ' + filterInfo.include_label_ids.length + '個指定');
      }
      
      if (filterInfo.include_case_category_ids && filterInfo.include_case_category_ids.length > 0) {
        filterDetails.push('分類: ' + filterInfo.include_case_category_ids.length + '個指定');
      }
      
      var detailText = filterDetails.length > 0 ? filterDetails.join(' / ') : '条件設定済み';
      
      filterInfoDiv.innerHTML = 
        '<div class="filter-status has-filter">' +
          '<span class="filter-icon">🔍</span>' +
          '<span class="filter-text">フィルタ適用: ' + detailText + '</span>' +
        '</div>';
    }
    
    selectedItem.appendChild(filterInfoDiv);
  }

  function confirmSelection() {
    console.log('confirmSelection呼び出し, selectedMunicipalityCode:', selectedMunicipalityCode);
    if (selectedMunicipalityCode) {
      // ボタンを無効化して重複実行を防止
      var confirmBtn = document.getElementById('confirmBtn');
      confirmBtn.disabled = true;
      
      console.log('processSelectedMunicipality呼び出し開始:', selectedMunicipalityCode);
      
      // 進捗表示エリアを作成
      showProgressDialog(configs[selectedMunicipalityCode].name);
      
      // 選択結果を直接渡してダイアログを閉じる
      setTimeout(function() { updateProgress('config', 'success'); }, 500);
      setTimeout(function() { updateProgress('tickets', 'success'); }, 1000);
      setTimeout(function() { updateProgress('filter', 'success'); }, 1200);
      setTimeout(function() { updateProgress('slack', 'success'); }, 1500);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('processSelectedMunicipality成功:', result);
          
          if (!result.success) {
            if (result.reason === 'no_tickets') {
              updateProgress('⏭️ チケットなしのため送信をスキップしました', 'skipped');
            } else if (result.reason === 'no_filtered_tickets') {
              updateProgress('🔍 フィルタ条件に該当するチケットがないため送信をスキップしました', 'skipped');
              showFilterResult(result);
            }
          } else {
            updateProgress('✅ 送信完了', 'success');
            showFilterResult(result);
          }
          
          // モーダルを手動で閉じる必要がある場合のためのボタンを表示
          showCloseButton();
        })
        .withFailureHandler(function(error) {
          console.error('processSelectedMunicipality失敗:', error);
          updateProgress('❌ エラー: ' + error, 'error');
          confirmBtn.disabled = false;
          confirmBtn.textContent = '「' + configs[selectedMunicipalityCode].name + '」に送信';
          
          // エラー時も手動クローズボタンを表示
          showCloseButton();
        })
        .processSelectedMunicipality(selectedMunicipalityCode);
    } else {
      console.log('自治体が選択されていません');
    }
  }

  function showFilterResult(result) {
    var filterResultDiv = document.createElement('div');
    filterResultDiv.className = 'filter-result';
    
    var filterStatus = '';
    if (!result.filterSettings) {
      filterStatus = 'フィルタ設定なし - 全チケット対象';
    } else {
      var conditions = [];
      if (result.filterSettings.include_label_ids && result.filterSettings.include_label_ids.length > 0) {
        conditions.push('ラベル' + result.filterSettings.include_label_ids.length + '個');
      }
      if (result.filterSettings.include_case_category_ids && result.filterSettings.include_case_category_ids.length > 0) {
        conditions.push('分類' + result.filterSettings.include_case_category_ids.length + '個');
      }
      filterStatus = 'フィルタ適用: ' + (conditions.length > 0 ? conditions.join(' / ') : '条件設定済み');
    }
    
    filterResultDiv.innerHTML = 
      '<div class="filter-summary">' +
        '<h3>📊 フィルタ適用結果</h3>' +
        '<div class="filter-detail">' +
          '<div class="count-info">' +
            '<span class="original-count">元チケット数: ' + result.originalCount + '件</span>' +
            '<span class="arrow">→</span>' +
            '<span class="filtered-count">送信対象: ' + result.filteredCount + '件</span>' +
          '</div>' +
          '<div class="filter-status-text">' + filterStatus + '</div>' +
        '</div>' +
      '</div>';
    
    var progressResult = document.getElementById('progressResult');
    progressResult.appendChild(filterResultDiv);
  }

  function showCloseButton() {
    // 既存のクローズボタンがある場合は何もしない
    if (document.getElementById('manualCloseBtn')) {
      return;
    }
    
    var closeButtonDiv = document.createElement('div');
    closeButtonDiv.className = 'manual-close-section';
    closeButtonDiv.innerHTML = 
      '<button id="manualCloseBtn" class="btn btn-primary manual-close-btn" onclick="google.script.host.close()">' +
        '閉じる' +
      '</button>';
    
    var progressResult = document.getElementById('progressResult');
    progressResult.appendChild(closeButtonDiv);
  }

  function showProgressDialog(municipalityName) {
    // 既存のコンテナを隠す
    document.querySelector('.container').style.display = 'none';
    
    // 進捗表示エリアを作成
    var progressContainer = document.createElement('div');
    progressContainer.id = 'progressContainer';
    progressContainer.className = 'progress-container';
    progressContainer.innerHTML = 
      '<div class="progress-header">' +
        '<h2>🚀 「' + municipalityName + '」への送信中</h2>' +
      '</div>' +
      '<div class="progress-steps">' +
        '<div class="progress-step" id="step1">' +
          '<div class="step-icon">⏳</div>' +
          '<div class="step-text">自治体設定を取得中...</div>' +
          '<div class="step-time">0.1〜0.3秒</div>' +
        '</div>' +
        '<div class="progress-step" id="step2">' +
          '<div class="step-icon">⏳</div>' +
          '<div class="step-text">チケットデータを抽出中...</div>' +
          '<div class="step-time">0.1〜0.5秒</div>' +
        '</div>' +
        '<div class="progress-step" id="step3">' +
          '<div class="step-icon">⏳</div>' +
          '<div class="step-text">フィルタ条件を適用中...</div>' +
          '<div class="step-time">0.01〜0.1秒</div>' +
        '</div>' +
        '<div class="progress-step" id="step4">' +
          '<div class="step-icon">⏳</div>' +
          '<div class="step-text">Slack APIに送信中...</div>' +
          '<div class="step-time">0.5〜3秒</div>' +
        '</div>' +
      '</div>' +
      '<div class="progress-result" id="progressResult"></div>';
    
    document.body.appendChild(progressContainer);
  }

  function updateProgress(step, status, message) {
    var stepMap = {
      'config': 'step1',
      'tickets': 'step2', 
      'filter': 'step3',
      'slack': 'step4'
    };
    
    if (stepMap[step]) {
      var stepElement = document.getElementById(stepMap[step]);
      var icon = stepElement.querySelector('.step-icon');
      var text = stepElement.querySelector('.step-text');
      
      if (status === 'success') {
        icon.textContent = '✅';
        stepElement.classList.add('completed');
      } else if (status === 'skipped') {
        icon.textContent = '⏭️';
        stepElement.classList.add('skipped');
      } else if (status === 'error') {
        icon.textContent = '❌';
        stepElement.classList.add('error');
      }
      
      if (message) {
        text.textContent = message;
      }
    } else {
      // 最終結果の表示
      var resultElement = document.getElementById('progressResult');
      resultElement.textContent = step;
      resultElement.className = 'progress-result ' + status;
    }
  }

  function hideProgressDialog() {
    var progressContainer = document.getElementById('progressContainer');
    if (progressContainer) {
      progressContainer.remove();
    }
    document.querySelector('.container').style.display = 'block';
  }

  // DOMロード後の初期化
  function initializeDialog() {
    // エンターキーで検索結果が1つの場合は自動選択
    var searchBox = document.getElementById('searchBox');
    if (searchBox) {
      searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          var visibleItems = document.querySelectorAll('.municipality-item:not(.hidden)');
          if (visibleItems.length === 1) {
            var municipalityId = visibleItems[0].getAttribute('data-id');
            selectMunicipality(municipalityId);
            confirmSelection();
          }
        }
      });

      // 初期フォーカス
      searchBox.focus();
    }
  }

  // ページ読み込み完了後に初期化を実行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDialog);
  } else {
    initializeDialog();
  }
</script>
