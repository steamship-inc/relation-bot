<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let selectedMunicipalityId = null;
let currentMunicipalityConfig = null;
let labelsMap = {};
let categoriesMap = {};
let currentFilter = {};

// DOMè¦ç´ 
const municipalitySelectionModal = document.getElementById('municipalitySelectionModal');
const filterConfigModal = document.getElementById('filterConfigModal');
const searchInput = document.getElementById('municipalitySearch');
const municipalityList = document.getElementById('municipalityList');
const selectButton = document.getElementById('selectButton');

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  initializeMunicipalitySelection();
});

// è‡ªæ²»ä½“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
function initializeMunicipalitySelection() {
  // æ¤œç´¢æ©Ÿèƒ½
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      filterMunicipalityList(this.value);
    });

    // Enterã‚­ãƒ¼ã§æ¤œç´¢/é¸æŠ
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleEnterKeyPress();
      }
    });
  }
}

// è‡ªæ²»ä½“ãƒªã‚¹ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
function filterMunicipalityList(searchTerm) {
  const searchTermLower = searchTerm.toLowerCase();
  const items = municipalityList.querySelectorAll('.municipality-item');
  let hasVisibleItems = false;
  
  items.forEach(function(item) {
    const name = item.querySelector('.municipality-name').textContent.toLowerCase();
    const id = item.dataset.id.toLowerCase();
    const prefecture = item.querySelector('.municipality-id').textContent.toLowerCase();
    
    if (name.includes(searchTermLower) || id.includes(searchTermLower) || prefecture.includes(searchTermLower)) {
      item.style.display = 'block';
      hasVisibleItems = true;
    } else {
      item.style.display = 'none';
    }
  });
  
  // æ¤œç´¢çµæœãªã—ã®è¡¨ç¤º
  showNoResultsMessage(!hasVisibleItems && searchTerm);
}

// æ¤œç´¢çµæœãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º/éè¡¨ç¤º
function showNoResultsMessage(show) {
  let noResultsDiv = document.getElementById('noResults');
  
  if (show) {
    if (!noResultsDiv) {
      noResultsDiv = document.createElement('div');
      noResultsDiv.id = 'noResults';
      noResultsDiv.className = 'no-results';
      noResultsDiv.textContent = 'è©²å½“ã™ã‚‹è‡ªæ²»ä½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
      municipalityList.appendChild(noResultsDiv);
    }
    noResultsDiv.style.display = 'block';
  } else if (noResultsDiv) {
    noResultsDiv.style.display = 'none';
  }
}

// Enterã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã®å‡¦ç†
function handleEnterKeyPress() {
  const visibleItems = Array.from(municipalityList.querySelectorAll('.municipality-item'))
    .filter(item => item.style.display !== 'none');
  
  if (visibleItems.length === 1) {
    // æ¤œç´¢çµæœãŒ1ã¤ã®å ´åˆã¯è‡ªå‹•é¸æŠ
    selectMunicipality(visibleItems[0].dataset.id);
  }
}

// è‡ªæ²»ä½“é¸æŠ
function selectMunicipality(messageBoxId) {
  // æ—¢å­˜ã®é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
  municipalityList.querySelectorAll('.municipality-item').forEach(function(item) {
    item.classList.remove('selected');
  });
  
  // æ–°ã—ã„é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
  const selectedItem = municipalityList.querySelector('[data-id="' + messageBoxId + '"]');
  if (selectedItem) {
    selectedItem.classList.add('selected');
    selectedMunicipalityId = messageBoxId;
    selectButton.disabled = false;
  }
}

// ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šç”»é¢ã«é€²ã‚€
function proceedToFilterConfig() {
  if (!selectedMunicipalityId) {
    alert('è‡ªæ²»ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é‡è¤‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
  selectButton.disabled = true;
  selectButton.textContent = 'ğŸ”„ è¨­å®šç”»é¢ã‚’æº–å‚™ä¸­...';
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  google.script.run
    .withSuccessHandler(function(result) {
      showFilterConfigModal(result);
    })
    .withFailureHandler(function(error) {
      alert('ã‚¨ãƒ©ãƒ¼: ' + error.toString());
      selectButton.disabled = false;
      selectButton.textContent = 'âœ… ã“ã®è‡ªæ²»ä½“ã§è¨­å®šã™ã‚‹';
    })
    .getFilterConfigData(selectedMunicipalityId);
}

// ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
function showFilterConfigModal(data) {
  currentMunicipalityConfig = data.config;
  labelsMap = data.labelsMap;
  categoriesMap = data.categoriesMap;
  currentFilter = data.currentFilter || {};
  
  // è‡ªæ²»ä½“æƒ…å ±ã‚’è¡¨ç¤º
  document.getElementById('selectedMunicipalityName').textContent = currentMunicipalityConfig.name;
  document.getElementById('selectedMessageBoxId').textContent = selectedMunicipalityId;
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
  generateCategoryCheckboxes();
  generateLabelCheckboxes();
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
  updatePreview();
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
  municipalitySelectionModal.style.display = 'none';
  filterConfigModal.style.display = 'block';
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  setupFilterConfigEventListeners();
}

// ãƒã‚±ãƒƒãƒˆåˆ†é¡ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
function generateCategoryCheckboxes() {
  const container = document.getElementById('includeCategories');
  container.innerHTML = '';
  
  for (const categoryId in categoriesMap) {
    const isChecked = currentFilter.include_case_category_ids && 
                     currentFilter.include_case_category_ids.includes(parseInt(categoryId));
    
    const checkboxItem = document.createElement('div');
    checkboxItem.className = 'checkbox-item';
    
    checkboxItem.innerHTML = `
      <input type="checkbox" id="include_category_${categoryId}" value="${categoryId}" ${isChecked ? 'checked' : ''}>
      <label for="include_category_${categoryId}">${categoryId}: ${categoriesMap[categoryId]}</label>
    `;
    
    container.appendChild(checkboxItem);
  }
}

// ãƒ©ãƒ™ãƒ«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
function generateLabelCheckboxes() {
  const container = document.getElementById('includeLabels');
  container.innerHTML = '';
  
  for (const labelId in labelsMap) {
    const isChecked = currentFilter.include_label_ids && 
                     currentFilter.include_label_ids.includes(parseInt(labelId));
    
    const checkboxItem = document.createElement('div');
    checkboxItem.className = 'checkbox-item';
    
    checkboxItem.innerHTML = `
      <input type="checkbox" id="include_label_${labelId}" value="${labelId}" ${isChecked ? 'checked' : ''}>
      <label for="include_label_${labelId}">${labelId}: ${labelsMap[labelId]}</label>
    `;
    
    container.appendChild(checkboxItem);
  }
}

// ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
function setupFilterConfigEventListeners() {
  // è¨­å®šå¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
  document.addEventListener('change', updatePreview);
}

// è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
function updatePreview() {
  const config = buildConfigFromForm();
  const preview = document.getElementById('configPreview');
  
  if (Object.keys(config).length === 0) {
    preview.textContent = 'ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šãªã—ï¼ˆå…¨ãƒã‚±ãƒƒãƒˆé€šçŸ¥ï¼‰';
  } else {
    preview.textContent = JSON.stringify(config, null, 2);
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
function buildConfigFromForm() {
  const config = {};
  
  // é€šçŸ¥å¯¾è±¡åˆ†é¡
  const includeCategories = [];
  document.querySelectorAll('#includeCategories input:checked').forEach(function(cb) {
    includeCategories.push(parseInt(cb.value));
  });
  if (includeCategories.length > 0) {
    config.include_case_category_ids = includeCategories;
  }
  
  // é€šçŸ¥å¯¾è±¡ãƒ©ãƒ™ãƒ«
  const includeLabels = [];
  document.querySelectorAll('#includeLabels input:checked').forEach(function(cb) {
    includeLabels.push(parseInt(cb.value));
  });
  if (includeLabels.length > 0) {
    config.include_label_ids = includeLabels;
  }
  
  return config;
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type, duration) {
  duration = duration || 3000;
  
  // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
  const existingNotification = document.querySelector('.notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
  const notification = document.createElement('div');
  notification.className = 'notification ' + type;
  notification.textContent = message;
  
  // ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
  document.body.appendChild(notification);
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
  setTimeout(function() {
    notification.classList.add('show');
  }, 10);
  
  // è‡ªå‹•ã§éè¡¨ç¤º
  setTimeout(function() {
    notification.classList.add('hide');
    setTimeout(function() {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// è¨­å®šä¿å­˜
function saveConfig() {
  const config = buildConfigFromForm();
  
  // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦çŠ¶æ…‹å¤‰æ›´
  const saveButton = document.querySelector('.save-btn');
  const originalText = saveButton.textContent;
  saveButton.disabled = true;
  saveButton.textContent = 'ğŸ”„ è¨­å®šã‚’ä¿å­˜ä¸­...';
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—
  google.script.run
    .withSuccessHandler(function() {
      saveButton.textContent = 'âœ… ä¿å­˜å®Œäº†';
      showNotification('âœ… ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success', 2000);
      setTimeout(function() {
        google.script.host.close();
      }, 2500);
    })
    .withFailureHandler(function(error) {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      saveButton.disabled = false;
      saveButton.textContent = originalText;
      showNotification('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.toString(), 'error', 5000);
    })
    .saveFilterConfig(selectedMunicipalityId, config);
}

// è‡ªæ²»ä½“é¸æŠç”»é¢ã«æˆ»ã‚‹
function goBackToMunicipalitySelection() {
  filterConfigModal.style.display = 'none';
  municipalitySelectionModal.style.display = 'block';
  
  // é¸æŠãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
  selectButton.disabled = false;
  selectButton.textContent = 'âœ… ã“ã®è‡ªæ²»ä½“ã§è¨­å®šã™ã‚‹';
}

// å…¨ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢
function clearAllFilters() {
  if (confirm('å…¨ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
    document.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
      cb.checked = false;
    });
    updatePreview();
  }
}
</script>
