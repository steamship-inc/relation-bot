# 運用ワークフローと操作手順

## 日常運用ワークフロー

### 定期実行パターン

#### 朝の業務開始時（推奨）
1. **全自治体チケット取得**: 「🎫未対応チケット取得」を実行
2. **統合状況確認**: 「🎫未対応チケット」シートで全体状況を把握
3. **優先対応決定**: 緊急度の高いチケットから対応順序を決定

#### 夕方の業務終了前（推奨）
1. **再度チケット取得**: 日中の変更を反映
2. **翌日対応準備**: 未解決チケットの引き継ぎ事項整理

### 緊急時対応パターン

#### 特定自治体への緊急通知
1. **手動Slack送信**: 「🔔Slack手動送信」を実行
2. **自治体選択**: 対象自治体を検索・選択
3. **即座通知**: 最新のチケット状況を即座に通知

#### 大量チケット発生時
1. **頻度調整**: より頻繁なチケット取得実行
2. **フィルタ調整**: 緊急度の高いチケットのみに絞り込み
3. **追加通知**: 関係者への追加Slack通知

## 機能別操作手順

### 🎫未対応チケット取得

#### 実行手順
1. スプレッドシートのメニューから「🟩 re:lation」を選択
2. 「🎫未対応チケット取得」をクリック
3. 処理開始の確認ダイアログで「OK」をクリック

#### 処理内容
- 📮受信箱シートから全自治体設定を読み込み
- 🎫未対応チケットシートを初期化
- 各自治体のチケットを順次取得（50件バッチ処理）
- チケット分類・ラベルのID→名前変換
- 設定済み自治体へのSlack自動通知
- レート制限対策（50件ごとに60秒待機）

#### 実行時間目安
- 自治体数50件の場合: 約5-10分
- 処理状況はシート上でリアルタイム表示

#### 注意点
- 処理中はシートを編集しない
- ネットワーク接続を安定させる
- 他のAPI操作と重複実行しない

### 🔔Slack手動送信

#### 実行手順
1. 事前に「🎫未対応チケット取得」を実行してデータを最新化
2. メニューから「🔔Slack手動送信」を選択
3. 自治体選択ダイアログが表示される
4. 検索ボックスで自治体名を入力（部分一致検索）
5. 対象自治体を選択して「送信」ボタンをクリック

#### 送信内容
- 自治体名
- 未対応チケット総数
- 最新チケット詳細（上位5件）
- re:lationへの直接リンク
- スプレッドシート確認案内

#### 活用シーン
- 緊急事態発生時の即座通知
- 特定自治体職員への個別連絡
- 会議前の状況共有

### 📮受信箱取得

#### 実行タイミング
- 新しい自治体が追加された時
- 受信箱情報に変更があった時
- 月1回程度の定期更新

#### 実行手順
1. メニューから「📮受信箱取得」を選択
2. 処理完了まで待機（約3-5分）
3. 「📮受信箱」シートで取得結果を確認

#### 取得内容
- 自治体ID
- 自治体名
- 都道府県
- 受信箱ID（re:lationのメッセージボックスID）
- 組織名（re:lation上の組織名）

### 🏷️マスタデータ取得

#### チケット分類取得
**実行タイミング**: 新しいチケット分類が追加された時

**手順**:
1. メニューから「🏷️チケット分類取得」を選択
2. 「🏷️チケット分類」シートで新しい分類を確認

#### ラベル取得
**実行タイミング**: 新しいラベルが追加された時

**手順**:
1. メニューから「🏷️ラベル取得」を選択
2. 「🏷️ラベル」シートで新しいラベルを確認

## 設定変更手順

### Slackチャンネル変更

#### 個別自治体の変更
1. 「📮受信箱」シートを開く
2. 対象自治体の行を特定
3. 「Slackチャンネル」列を編集（例: `#new-channel-name`）
4. 保存後、次回通知時から新しいチャンネルに送信

#### 一括変更
1. 「📮受信箱」シートで複数行を選択
2. 一括編集機能で同時変更
3. パターン置換での効率的変更

### 通知条件変更

#### 検索条件の調整
1. 「📮受信箱」シートの「チケット検索条件(JSON)」列を編集
2. JSON形式で条件を指定：

```json
{
  "openTickets": {
    "status_cds": ["open", "in_progress"],
    "per_page": 50,
    "date_range": { "start": 7, "end": 0 }
  }
}
```

#### 通知テンプレートの調整
1. 「📮受信箱」シートの「Slack通知テンプレート(JSON)」列を編集
2. メッセージ形式をカスタマイズ

### 新自治体追加

#### 手順
1. 「📮受信箱取得」を実行して最新の自治体情報を取得
2. 新しく追加された行でSlack設定を編集
3. 通知テスト実行で動作確認

#### 設定項目
- Slackチャンネル名
- 通知有効フラグ
- 検索条件（必要に応じて）
- 通知テンプレート（必要に応じて）

## パフォーマンス最適化

### 処理時間短縮
- **バッチサイズ調整**: 自治体数に応じて処理バッチサイズを調整
- **対象自治体絞り込み**: 通知有効フラグでの処理対象制限
- **条件最適化**: 検索条件での取得データ量制限

### エラー対応
- **個別自治体エラー**: 全体処理への影響を最小化
- **リトライ機能**: 一時的なAPI障害への自動対応
- **ログ出力**: 詳細なエラー情報の記録

### 運用監視
- **処理時間監視**: 異常な処理時間の検知
- **エラー率監視**: API呼び出し成功率の監視
- **通知送信監視**: Slack通知送信成功率の監視
