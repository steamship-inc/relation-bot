# セットアップと初期設定

## 前提条件

- Google Apps Script環境
- re:lation APIアクセス権限
- Slack Bot Token

## 初期セットアップ手順

### 1. スクリプトプロパティ設定

Google Apps Scriptのスクリプトプロパティに以下を設定：

| キー | 値 | 説明 |
|---|---|---|
| `RELATION_API_KEY` | re:lation APIキー | re:lation APIへのアクセス用 |
| `SLACK_BOT_TOKEN` | Slack Bot Token | Slack通知送信用 |

### 2. 受信箱情報取得

1. スプレッドシートを開く
2. メニューから「🟩 re:lation」→「📮受信箱取得」を実行
3. 全自治体のメッセージボックス情報が「📮受信箱」シートに作成される

### 3. マスタデータ取得

#### チケット分類取得
1. メニューから「🟩 re:lation」→「🏷️チケット分類取得」を実行
2. チケット分類マスタが「🏷️チケット分類」シートに作成される

#### ラベル取得
1. メニューから「🟩 re:lation」→「🏷️ラベル取得」を実行
2. ラベルマスタが「🏷️ラベル」シートに作成される

### 4. 自治体設定調整

「📮受信箱」シートで各自治体の設定を編集：

#### 基本設定
- **自治体名**: 表示名
- **都道府県**: 所在地
- **受信箱ID**: re:lationのメッセージボックスID（自動取得済み）

#### Slack設定
- **Slackチャンネル**: 通知先チャンネル（例: `#yamaga-tickets`）
- **通知有効フラグ**: `TRUE`/`FALSE`での通知制御

#### 検索条件設定（JSON）
チケット検索条件をJSON形式で設定：

```json
{
  "openTickets": {
    "status_cds": ["open"],
    "per_page": 100,
    "page": 1
  }
}
```

#### Slack通知テンプレート設定（JSON）
通知メッセージテンプレートをJSON形式で設定：

```json
{
  "headerTemplate": "🎫 *{municipalityName} - 未対応チケット状況報告*\n\n📊 未対応チケット数: *{totalCount}件*\n\n",
  "ticketListHeader": "📋 *最新チケット（上位{displayCount}件）:*\n",
  "ticketItemTemplate": "• <{ticketUrl}|#{ticketId}> {title}\n  作成: {createdAt} | 更新: {updatedAt}\n",
  "remainingTicketsMessage": "\n... 他 {remainingCount}件のチケットがあります\n",
  "footerMessage": "\n💡 詳細はスプレッドシートをご確認ください",
  "noTicketsMessage": "✅ {municipalityName} - 未対応チケットはありません！",
  "maxDisplayCount": 5
}
```

## 動作確認

### 1. テスト実行
1. メニューから「🟩 re:lation」→「🎫未対応チケット取得」を実行
2. 「🎫未対応チケット」シートにデータが表示されることを確認
3. 設定済み自治体にSlack通知が送信されることを確認

### 2. 手動通知テスト
1. メニューから「🟩 re:lation」→「🔔Slack手動送信」を実行
2. 自治体選択ダイアログが表示されることを確認
3. 特定自治体を選択してSlack通知が送信されることを確認

## トラブルシューティング

### よくある問題

#### API認証エラー
- **症状**: APIキーエラーが発生
- **解決策**: スクリプトプロパティの`RELATION_API_KEY`を確認

#### Slack通知送信失敗
- **症状**: Slack通知が送信されない
- **解決策**: 
  1. `SLACK_BOT_TOKEN`の設定確認
  2. Slackチャンネル名の確認（#付きで記載）
  3. Bot権限の確認

#### レート制限エラー
- **症状**: API呼び出しが制限される
- **解決策**: 
  1. 処理の間隔を空ける
  2. バッチサイズを小さくする（デフォルト50件）

#### データ取得失敗
- **症状**: 特定自治体のデータが取得できない
- **解決策**:
  1. 受信箱IDの確認
  2. 自治体の設定確認
  3. コード表の確認

### ログ確認方法

Google Apps Scriptの実行ログで詳細エラーを確認：
1. Apps Script エディタを開く
2. 「実行数」タブでログを確認
3. エラー詳細を確認して対応

### 設定リセット

問題が解決しない場合の設定リセット手順：
1. 「📮受信箱」「🎫未対応チケット」シートを削除
2. メニューから各取得機能を再実行
3. 設定を再編集
