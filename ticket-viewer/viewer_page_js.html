<script>
  var municipalities = {};
  var currentTickets = [];
  var currentTicketDetail = null;
  var isLoading = false;

  function showLoading() {
    if (isLoading) return;
    isLoading = true;
    
    document.getElementById('loadBtn').disabled = true;
    document.getElementById('loadBtn').textContent = '⏳ 読み込み中...';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>チケット詳細を読み込み中...</div>
      </div>
    `;
  }

  function showError(message) {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = '📄 詳細を表示';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="error">
        <strong>エラー:</strong> ${escapeHtml(message)}
      </div>
      <div class="empty-state">
        <div class="icon">⚠️</div>
        <div>別のチケットを試してみてください</div>
      </div>
    `;
  }

  function showEmpty() {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = '📄 詳細を表示';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="empty-state">
        <div class="icon">💬</div>
        <div>上記でチケットを選択してください</div>
        <div style="margin-top: 8px; font-size: 14px; color: #999;">
          自治体を選択するとチケット一覧が表示されます
        </div>
      </div>
    `;
  }

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      var date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return dateString;
    }
  }

  function loadTicketList() {
    var municipalityId = document.getElementById('municipalitySelect').value;
    var ticketSelect = document.getElementById('ticketSelect');
    var loadBtn = document.getElementById('loadBtn');
    
    // 自治体が選択されていない場合
    if (!municipalityId) {
      ticketSelect.innerHTML = '<option value="">まず自治体を選択してください</option>';
      ticketSelect.disabled = true;
      loadBtn.disabled = true;
      currentTickets = [];
      return;
    }
    
    var municipality = municipalities[municipalityId];
    if (!municipality) {
      showError('選択された自治体の情報が見つかりません');
      return;
    }
    
    // ローディング状態に設定
    ticketSelect.innerHTML = '<option value="">📥 チケット一覧を読み込み中...</option>';
    ticketSelect.disabled = true;
    loadBtn.disabled = true;
    
    // チケット一覧を取得
    google.script.run
      .withSuccessHandler(function(tickets) {
        currentTickets = tickets || [];
        populateTicketSelect();
      })
      .withFailureHandler(function(error) {
        ticketSelect.innerHTML = '<option value="">❌ 読み込み失敗</option>';
        showError('チケット一覧の取得に失敗しました: ' + error.toString());
      })
      .fetchTicketList(municipality.messageBoxId);
  }

  function populateTicketSelect() {
    var ticketSelect = document.getElementById('ticketSelect');
    var loadBtn = document.getElementById('loadBtn');
    
    if (currentTickets.length === 0) {
      ticketSelect.innerHTML = '<option value="">📭 チケットがありません</option>';
      ticketSelect.disabled = true;
      loadBtn.disabled = true;
      return;
    }
    
    // チケット選択肢を作成
    var optionsHtml = '<option value="">チケットを選択...</option>';
    currentTickets.forEach(function(ticket) {
      var title = ticket.title || 'タイトルなし';
      // タイトルが長い場合は省略
      if (title.length > 50) {
        title = title.substring(0, 47) + '...';
      }
      optionsHtml += `<option value="${ticket.ticket_id}">[${ticket.ticket_id}] ${escapeHtml(title)}</option>`;
    });
    
    ticketSelect.innerHTML = optionsHtml;
    ticketSelect.disabled = false;
    ticketSelect.onchange = function() {
      loadBtn.disabled = !this.value;
    };
    
    console.log('🎫 チケット一覧読み込み完了: ' + currentTickets.length + '件');
  }

  function loadMunicipalities() {
    var municipalitySelect = document.getElementById('municipalitySelect');
    
    // ローディング状態に設定
    municipalitySelect.innerHTML = '<option value="">📥 自治体一覧を読み込み中...</option>';
    municipalitySelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(configs) {
        municipalities = configs;
        populateMunicipalitySelect();
      })
      .withFailureHandler(function(error) {
        municipalitySelect.innerHTML = '<option value="">❌ 読み込み失敗</option>';
        showError('自治体一覧の読み込みに失敗しました: ' + error.toString());
      })
      .loadMunicipalitiesFromOpenTicketSheet();
  }

  function populateMunicipalitySelect() {
    var municipalitySelect = document.getElementById('municipalitySelect');
    
    if (Object.keys(municipalities).length === 0) {
      municipalitySelect.innerHTML = '<option value="">📭 自治体設定がありません</option>';
      municipalitySelect.disabled = true;
      return;
    }
    
    municipalitySelect.innerHTML = '<option value="">自治体を選択...</option>';
    
    Object.keys(municipalities).forEach(function(id) {
      var option = document.createElement('option');
      option.value = id;
      option.textContent = municipalities[id].name;
      municipalitySelect.appendChild(option);
    });
    
    municipalitySelect.disabled = false;
    console.log('🏛️ 自治体一覧読み込み完了: ' + Object.keys(municipalities).length + '件');
  }

  function loadTicketDetail() {
    var municipalityId = document.getElementById('municipalitySelect').value;
    var ticketId = document.getElementById('ticketSelect').value;
    
    if (!municipalityId) {
      alert('自治体を選択してください');
      return;
    }
    
    if (!ticketId) {
      alert('チケットを選択してください');
      return;
    }
    
    var municipality = municipalities[municipalityId];
    if (!municipality) {
      showError('選択された自治体の情報が見つかりません');
      return;
    }
    
    showLoading();
    
    google.script.run
      .withSuccessHandler(function(ticketDetail) {
        displayTicketDetail(ticketDetail, municipality);
      })
      .withFailureHandler(function(error) {
        showError('チケット詳細の取得に失敗しました: ' + error.toString());
      })
      .fetchTicketDetailWithSheetTitle(municipality.messageBoxId, ticketId);
  }

  function displayTicketDetail(ticketDetail, municipality) {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = '📄 詳細を表示';
    currentTicketDetail = ticketDetail;
    
    if (!ticketDetail) {
      showError('チケット詳細が取得できませんでした');
      return;
    }

    var messagesHtml = '';
    if (ticketDetail.messages && ticketDetail.messages.length > 0) {
      ticketDetail.messages.forEach(function(message, index) {
        var attachmentsHtml = '';
        if (message.attachments && message.attachments.length > 0) {
          attachmentsHtml = `<div class="attachments">📎 添付ファイル: ${message.attachments.length}件</div>`;
        }
        
        messagesHtml += `
          <div class="message">
            <div class="message-header">
              <div class="message-title">${index + 1}. ${escapeHtml(message.title || 'メッセージ')}</div>
              <div class="message-date">${formatDate(message.created_at)}</div>
            </div>
            <div class="message-info">
              <div class="message-from"><strong>差出人:</strong> ${escapeHtml(message.from || '')}</div>
              <div class="message-to"><strong>宛先:</strong> ${escapeHtml(message.to || '')}</div>
            </div>
            <div class="message-body">${escapeHtml(message.body || '内容なし')}</div>
            ${attachmentsHtml}
          </div>
        `;
      });
    } else {
      messagesHtml = `
        <div class="message">
          <div style="text-align: center; color: #999; padding: 40px;">
            メッセージがありません
          </div>
        </div>
      `;
    }

    var ticketUrl = `https://www.relation.jp/tickets/#/${municipality.messageBoxId}/tickets/open/p1/${ticketDetail.ticket_id}`;

    document.getElementById('ticketContent').innerHTML = `
      <div class="ticket-detail">
        <div class="ticket-header">
          <div class="ticket-title">${escapeHtml(ticketDetail.title || 'タイトルなし')}</div>
          <div class="ticket-meta">
            <div class="meta-item">
              <span class="meta-label">チケットID:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.ticket_id || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">自治体:</span>
              <span class="meta-value">${escapeHtml(municipality.name || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ステータス:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.status_cd || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">担当者:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.assignee || '未割当')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">作成日:</span>
              <span class="meta-value">${formatDate(ticketDetail.created_at)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">更新日:</span>
              <span class="meta-value">${formatDate(ticketDetail.last_updated_at)}</span>
            </div>
          </div>
          <a href="${ticketUrl}" target="_blank" class="external-link">🔗 re:lationで開く</a>
        </div>
        
        <div class="messages-section">
          <div class="messages-header">💬 メッセージ履歴 (${ticketDetail.messages ? ticketDetail.messages.length : 0}件)</div>
          ${messagesHtml}
        </div>
      </div>
    `;
  }

  // 初期化
  document.addEventListener('DOMContentLoaded', function() {
    loadMunicipalities();
  });
</script>
