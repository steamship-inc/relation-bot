<script>
  var municipalities = {};
  var currentTickets = [];
  var currentTicketDetail = null;
  var isLoading = false;

  function showLoading() {
    if (isLoading) return;
    isLoading = true;
    
    document.getElementById('loadBtn').disabled = true;
    document.getElementById('loadBtn').textContent = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>ãƒã‚±ãƒƒãƒˆè©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    `;
  }

  function showError(message) {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = 'ğŸ“„ è©³ç´°ã‚’è¡¨ç¤º';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="error">
        <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${escapeHtml(message)}
      </div>
      <div class="empty-state">
        <div class="icon">âš ï¸</div>
        <div>åˆ¥ã®ãƒã‚±ãƒƒãƒˆã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„</div>
      </div>
    `;
  }

  function showEmpty() {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = 'ğŸ“„ è©³ç´°ã‚’è¡¨ç¤º';
    
    document.getElementById('ticketContent').innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ’¬</div>
        <div>ä¸Šè¨˜ã§ãƒã‚±ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div style="margin-top: 8px; font-size: 14px; color: #999;">
          è‡ªæ²»ä½“ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </div>
    `;
  }

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      var date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return dateString;
    }
  }

  function loadTicketList() {
    var municipalityId = document.getElementById('municipalitySelect').value;
    var ticketSelect = document.getElementById('ticketSelect');
    var loadBtn = document.getElementById('loadBtn');
    
    // è‡ªæ²»ä½“ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
    if (!municipalityId) {
      ticketSelect.innerHTML = '<option value="">ã¾ãšè‡ªæ²»ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      ticketSelect.disabled = true;
      loadBtn.disabled = true;
      currentTickets = [];
      return;
    }
    
    var municipality = municipalities[municipalityId];
    if (!municipality) {
      showError('é¸æŠã•ã‚ŒãŸè‡ªæ²»ä½“ã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«è¨­å®š
    ticketSelect.innerHTML = '<option value="">ğŸ“¥ ãƒã‚±ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>';
    ticketSelect.disabled = true;
    loadBtn.disabled = true;
    
    // ãƒã‚±ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—
    google.script.run
      .withSuccessHandler(function(tickets) {
        currentTickets = tickets || [];
        populateTicketSelect();
      })
      .withFailureHandler(function(error) {
        ticketSelect.innerHTML = '<option value="">âŒ èª­ã¿è¾¼ã¿å¤±æ•—</option>';
        showError('ãƒã‚±ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
      })
      .fetchTicketList(municipality.messageBoxId);
  }

  function populateTicketSelect() {
    var ticketSelect = document.getElementById('ticketSelect');
    var loadBtn = document.getElementById('loadBtn');
    
    if (currentTickets.length === 0) {
      ticketSelect.innerHTML = '<option value="">ğŸ“­ ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
      ticketSelect.disabled = true;
      loadBtn.disabled = true;
      return;
    }
    
    // ãƒã‚±ãƒƒãƒˆé¸æŠè‚¢ã‚’ä½œæˆ
    var optionsHtml = '<option value="">ãƒã‚±ãƒƒãƒˆã‚’é¸æŠ...</option>';
    currentTickets.forEach(function(ticket) {
      var title = ticket.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
      // ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã„å ´åˆã¯çœç•¥
      if (title.length > 50) {
        title = title.substring(0, 47) + '...';
      }
      optionsHtml += `<option value="${ticket.ticket_id}">[${ticket.ticket_id}] ${escapeHtml(title)}</option>`;
    });
    
    ticketSelect.innerHTML = optionsHtml;
    ticketSelect.disabled = false;
    ticketSelect.onchange = function() {
      loadBtn.disabled = !this.value;
    };
    
    console.log('ğŸ« ãƒã‚±ãƒƒãƒˆä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†: ' + currentTickets.length + 'ä»¶');
  }

  function loadMunicipalities() {
    var municipalitySelect = document.getElementById('municipalitySelect');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«è¨­å®š
    municipalitySelect.innerHTML = '<option value="">ğŸ“¥ è‡ªæ²»ä½“ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>';
    municipalitySelect.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(configs) {
        municipalities = configs;
        populateMunicipalitySelect();
      })
      .withFailureHandler(function(error) {
        municipalitySelect.innerHTML = '<option value="">âŒ èª­ã¿è¾¼ã¿å¤±æ•—</option>';
        showError('è‡ªæ²»ä½“ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
      })
      .loadMunicipalitiesFromOpenTicketSheet();
  }

  function populateMunicipalitySelect() {
    var municipalitySelect = document.getElementById('municipalitySelect');
    
    if (Object.keys(municipalities).length === 0) {
      municipalitySelect.innerHTML = '<option value="">ğŸ“­ è‡ªæ²»ä½“è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</option>';
      municipalitySelect.disabled = true;
      return;
    }
    
    municipalitySelect.innerHTML = '<option value="">è‡ªæ²»ä½“ã‚’é¸æŠ...</option>';
    
    Object.keys(municipalities).forEach(function(id) {
      var option = document.createElement('option');
      option.value = id;
      option.textContent = municipalities[id].name;
      municipalitySelect.appendChild(option);
    });
    
    municipalitySelect.disabled = false;
    console.log('ğŸ›ï¸ è‡ªæ²»ä½“ä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†: ' + Object.keys(municipalities).length + 'ä»¶');
  }

  function loadTicketDetail() {
    var municipalityId = document.getElementById('municipalitySelect').value;
    var ticketId = document.getElementById('ticketSelect').value;
    
    if (!municipalityId) {
      alert('è‡ªæ²»ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    if (!ticketId) {
      alert('ãƒã‚±ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    var municipality = municipalities[municipalityId];
    if (!municipality) {
      showError('é¸æŠã•ã‚ŒãŸè‡ªæ²»ä½“ã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    showLoading();
    
    google.script.run
      .withSuccessHandler(function(ticketDetail) {
        displayTicketDetail(ticketDetail, municipality);
      })
      .withFailureHandler(function(error) {
        showError('ãƒã‚±ãƒƒãƒˆè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.toString());
      })
      .fetchTicketDetailWithSheetTitle(municipality.messageBoxId, ticketId);
  }

  function displayTicketDetail(ticketDetail, municipality) {
    isLoading = false;
    document.getElementById('loadBtn').disabled = false;
    document.getElementById('loadBtn').textContent = 'ğŸ“„ è©³ç´°ã‚’è¡¨ç¤º';
    currentTicketDetail = ticketDetail;
    
    if (!ticketDetail) {
      showError('ãƒã‚±ãƒƒãƒˆè©³ç´°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }

    var messagesHtml = '';
    if (ticketDetail.messages && ticketDetail.messages.length > 0) {
      ticketDetail.messages.forEach(function(message, index) {
        var attachmentsHtml = '';
        if (message.attachments && message.attachments.length > 0) {
          attachmentsHtml = `<div class="attachments">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${message.attachments.length}ä»¶</div>`;
        }
        
        messagesHtml += `
          <div class="message">
            <div class="message-header">
              <div class="message-title">${index + 1}. ${escapeHtml(message.title || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸')}</div>
              <div class="message-date">${formatDate(message.created_at)}</div>
            </div>
            <div class="message-info">
              <div class="message-from"><strong>å·®å‡ºäºº:</strong> ${escapeHtml(message.from || '')}</div>
              <div class="message-to"><strong>å®›å…ˆ:</strong> ${escapeHtml(message.to || '')}</div>
            </div>
            <div class="message-body">${escapeHtml(message.body || 'å†…å®¹ãªã—')}</div>
            ${attachmentsHtml}
          </div>
        `;
      });
    } else {
      messagesHtml = `
        <div class="message">
          <div style="text-align: center; color: #999; padding: 40px;">
            ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      `;
    }

    var ticketUrl = `https://www.relation.jp/tickets/#/${municipality.messageBoxId}/tickets/open/p1/${ticketDetail.ticket_id}`;

    document.getElementById('ticketContent').innerHTML = `
      <div class="ticket-detail">
        <div class="ticket-header">
          <div class="ticket-title">${escapeHtml(ticketDetail.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')}</div>
          <div class="ticket-meta">
            <div class="meta-item">
              <span class="meta-label">ãƒã‚±ãƒƒãƒˆID:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.ticket_id || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">è‡ªæ²»ä½“:</span>
              <span class="meta-value">${escapeHtml(municipality.name || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.status_cd || '')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">æ‹…å½“è€…:</span>
              <span class="meta-value">${escapeHtml(ticketDetail.assignee || 'æœªå‰²å½“')}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ä½œæˆæ—¥:</span>
              <span class="meta-value">${formatDate(ticketDetail.created_at)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">æ›´æ–°æ—¥:</span>
              <span class="meta-value">${formatDate(ticketDetail.last_updated_at)}</span>
            </div>
          </div>
          <a href="${ticketUrl}" target="_blank" class="external-link">ğŸ”— re:lationã§é–‹ã</a>
        </div>
        
        <div class="messages-section">
          <div class="messages-header">ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ (${ticketDetail.messages ? ticketDetail.messages.length : 0}ä»¶)</div>
          ${messagesHtml}
        </div>
      </div>
    `;
  }

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    loadMunicipalities();
  });
</script>
