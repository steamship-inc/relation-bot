<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>チケット詳細</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #fafafa;
      color: #333;
      line-height: 1.4;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .ticket-detail {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .ticket-header {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      padding: 16px;
    }

    .ticket-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 8px 0;
      line-height: 1.3;
    }

    .ticket-meta {
      font-size: 12px;
      opacity: 0.9;
    }

    .ticket-body {
      padding: 16px;
    }

    .field-group {
      margin-bottom: 20px;
    }

    .field-label {
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-value {
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid #4285f4;
      word-break: break-word;
    }

    .field-value.empty {
      color: #999;
      font-style: italic;
    }

    .date {
      color: #666;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .loading .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      border-left: 3px solid #c62828;
    }

    .municipality-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      border-left: 3px solid #34a853;
    }

    .municipality-name {
      font-weight: 600;
      color: #333;
    }

    .message-content {
      max-height: 200px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin-top: 8px;
      border-left: 3px solid #ff9800;
    }

    .external-link {
      display: inline-block;
      background: #4285f4;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      margin-top: 12px;
      transition: background-color 0.2s;
    }

    .external-link:hover {
      background: #3367d6;
    }

    .refresh-hint {
      font-size: 11px;
      color: #999;
      text-align: center;
      margin-top: 16px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="content">
    <div class="empty-state">
      <div class="icon">💬</div>
      <div>チケットの行を選択してください</div>
      <div style="margin-top: 8px; font-size: 11px; color: #999;">
        🎫未対応チケットシートで<br>
        任意の行をクリックすると<br>
        メッセージ履歴が表示されます
      </div>
    </div>
  </div>

  <script>
    // サイドバー状態の管理
    var currentTicketId = null;
    var isLoading = false;

    function showLoading() {
      if (isLoading) return; // 重複防止
      isLoading = true;
      
      document.getElementById('content').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>チケット詳細を読み込み中...</div>
        </div>
      `;
    }

    function showError(message) {
      isLoading = false;
      document.getElementById('content').innerHTML = `
        <div class="error">
          <strong>エラー:</strong> ${escapeHtml(message)}
        </div>
        <div class="empty-state">
          <div class="icon">⚠️</div>
          <div>別の行を選択してみてください</div>
        </div>
      `;
    }

    function showEmpty() {
      isLoading = false;
      currentTicketId = null;
      document.getElementById('content').innerHTML = `
        <div class="empty-state">
          <div class="icon">💬</div>
          <div>チケットの行を選択してください</div>
          <div style="margin-top: 8px; font-size: 11px; color: #999;">
            🎫未対応チケットシートで<br>
            任意の行をクリックすると<br>
            メッセージ履歴が表示されます
          </div>
        </div>
      `;
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        var date = new Date(dateString);
        return date.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString;
      }
    }

    function updateTicketDetail(ticketDetail, municipalityName, messageBoxId) {
      isLoading = false;
      
      if (!ticketDetail) {
        showEmpty();
        return;
      }

      // 同じチケットの場合は更新しない（パフォーマンス向上）
      if (currentTicketId === ticketDetail.ticket_id) {
        return;
      }
      currentTicketId = ticketDetail.ticket_id;

      var messagesHtml = '';
      if (ticketDetail.messages && ticketDetail.messages.length > 0) {
        ticketDetail.messages.forEach(function(message, index) {
          if (index > 0) messagesHtml += '<hr style="margin: 16px 0; border: none; border-top: 1px solid #ddd;">';
          
          messagesHtml += '<div style="margin-bottom: 16px;">';
          messagesHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
          messagesHtml += '<strong style="color: #333;">' + (index + 1) + '. ' + escapeHtml(message.title || 'メッセージ') + '</strong>';
          messagesHtml += '<span style="color: #666; font-size: 11px;">' + formatDate(message.created_at) + '</span>';
          messagesHtml += '</div>';
          
          if (message.from) {
            messagesHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 4px;"><strong>差出人:</strong> ' + escapeHtml(message.from) + '</div>';
          }
          
          if (message.to) {
            messagesHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 8px;"><strong>宛先:</strong> ' + escapeHtml(message.to) + '</div>';
          }
          
          messagesHtml += '<div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #4285f4;">';
          messagesHtml += escapeHtml(message.body || '内容なし').replace(/\n/g, '<br>');
          messagesHtml += '</div>';
          
          if (message.attachments && message.attachments.length > 0) {
            messagesHtml += '<div style="margin-top: 8px; font-size: 12px; color: #666;">📎 添付ファイル: ' + message.attachments.length + '件</div>';
          }
          
          messagesHtml += '</div>';
        });
      } else {
        messagesHtml = '<div style="text-align: center; color: #999; padding: 40px;">メッセージがありません</div>';
      }

      var ticketUrl = 'https://www.relation.jp/tickets/#/' + messageBoxId + '/tickets/open/p1/' + ticketDetail.ticket_id;

      document.getElementById('content').innerHTML = `
        <div class="ticket-detail">
          <div class="ticket-header">
            <div class="ticket-title">💬 メッセージ履歴</div>
            <div class="ticket-meta">
              ID: ${escapeHtml(ticketDetail.ticket_id || '')} | ${escapeHtml(municipalityName || '')}
            </div>
          </div>

          <div class="ticket-body">
            ${messagesHtml}

            <div class="refresh-hint">
              💡 別の行を選択するとメッセージが切り替わります
            </div>
          </div>
        </div>
      `;
    }

    // 定期的にシートの選択状態をチェック
    function checkForSelectionChange() {
      if (isLoading) return; // ローディング中はスキップ
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.type) {
            switch(result.type) {
              case 'detail':
                updateTicketDetail(result.ticketDetail, result.municipalityName, result.messageBoxId);
                break;
              case 'empty':
                showEmpty();
                break;
              case 'loading':
                showLoading();
                break;
              case 'error':
                showError(result.message || 'エラーが発生しました');
                break;
            }
          }
        })
        .withFailureHandler(function(error) {
          if (!isLoading) {
            showError('データの取得に失敗しました: ' + error.toString());
          }
        })
        .getSidebarTicketData();
    }

    // 初期化とポーリング開始
    document.addEventListener('DOMContentLoaded', function() {
      // 初回チェック
      checkForSelectionChange();
      
      // 1秒ごとにチェック（リアルタイムに近い更新）
      setInterval(checkForSelectionChange, 1000);
    });

    // Google Apps Scriptからの呼び出し用グローバル関数（互換性のため残す）
    window.showLoading = showLoading;
    window.showError = showError;
    window.showEmpty = showEmpty;
    window.updateTicketDetail = updateTicketDetail;
  </script>
</body>
</html>
